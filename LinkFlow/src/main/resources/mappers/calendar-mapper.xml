<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="calendarMapper">
	<resultMap type="calendarDto" id="calendarResult" extends="commonMapper.commonResult">
		<id column="CAL_NO" property="calNo"/>
		<result column="DEPT_CODE" property="deptCode"/>
		<result column="CAL_SUB_CODE" property="calSubCode"/>
		<result column="CAL_COLOR" property="calColor"/>
	  <collection property="schedules" ofType="scheduleDto" resultMap="scheduleResult"/>
	</resultMap>
	
	<resultMap type="scheduleDto" id="scheduleResult" extends="commonMapper.commonResult">
     <id column="SCH_NO" property="schNo"/>
     <result column="CAL_NO" property="calNo"/>
     <result column="SCH_CONTENT" property="schContent"/>
     <result column="START_DATE" property="startDate"/>
     <result column="END_DATE" property="endDate"/>
     <result column="ADDRESS" property="address"/>
     <result column="SCH_IMPORT" property="schImport"/>
     <result column="NOTIFY_YN" property="notifyYn"/>
     <result column="SCH_TITLE" property="schTitle"/>
 		 <result column="CAL_COLOR" property="calColor"/>
  	 <result column="CAL_SUB_CODE" property="schCalSubCode"/>
  	 <result column="MOD_DATE" property="modDate"/>
 </resultMap>
						
		
	<!-- 일정등록 -->
	<insert id="insertSch">
	    INSERT INTO TB_SCHEDULE
	    (
	        SCH_NO,
	        CAL_NO, 
	        SCH_CONTENT,
	        START_DATE,
	        END_DATE,
	        ADDRESS,
	        SCH_IMPORT,
	        NOTIFY_YN,
	        REG_DATE,
	        MOD_DATE,
	        MOD_ID,
	        DEL_YN,
	        SCH_TITLE
	    )
	    VALUES
	    (
	        SEQ_SCHNO.nextval,
	        (
	            SELECT CAL_NO
	            FROM TB_CALENDAR
	            WHERE CAL_SUB_CODE = #{schCalSubCode}
	            AND REG_ID = #{modId} <!-- userId -->
	        ),
	        #{schContent},
	        TO_DATE(#{startDate}, 'YYYY-MM-DD"T"HH24:MI'),
					TO_DATE(#{endDate}, 'YYYY-MM-DD"T"HH24:MI'),
	        #{address},
	        #{schImport},
	        #{notifyYn},
	        SYSDATE,
	        SYSDATE,
	        #{modId},
	        'N',
	        #{schTitle}  
	    )
	</insert>

	<!-- 전체일정 조회(특정 캘린더)  -->
	<select id="selectScheduleList" resultMap="scheduleResult">
    SELECT 
        S.SCH_NO,
        S.SCH_CONTENT,
        TO_CHAR(S.START_DATE, 'YYYY-MM-DD"T"HH24:MI') AS START_DATE,
        TO_CHAR(S.END_DATE, 'YYYY-MM-DD"T"HH24:MI') AS END_DATE,
        S.ADDRESS,
        S.SCH_IMPORT,
        S.NOTIFY_YN,
        S.SCH_TITLE,
        C.CAL_COLOR,
        C.CAL_SUB_CODE,
        C.CAL_NO
    FROM TB_SCHEDULE S
    LEFT JOIN TB_CALENDAR C ON C.CAL_NO = S.CAL_NO
    LEFT JOIN TB_MEMBER M ON C.REG_ID = M.USER_ID
    WHERE 
         <choose>
            <when test="schCalSubCode == '01'">
                 M.SP_RIGHT = 'Y' 
                 AND S.DEL_YN = 'N'
                 AND C.CAL_SUB_CODE = '01'
            </when>
            <when test="schCalSubCode == '02'">
                 M.DEPT_CODE IN (
                    SELECT DEPT_CODE 
                    FROM TB_MEMBER 
                    WHERE USER_ID = #{userId}                     
                )AND M.DEPT_RIGHT = 'Y' 
                AND S.DEL_YN = 'N'
                AND C.CAL_SUB_CODE = '02'
            </when>
            <when test="schCalSubCode == '03'">
              	 S.MOD_ID = #{userId} 
              	 AND S.DEL_YN = 'N'
              	 AND C.CAL_SUB_CODE = '03'
            </when>
        </choose>
</select>
	 
	<!-- 일정수정 -->
	<update id="updateSch">
	    UPDATE TB_SCHEDULE
	    SET
	        SCH_TITLE = #{schTitle},
	        SCH_IMPORT = #{schImport},
	        START_DATE = TO_DATE(#{startDate}, 'YYYY-MM-DD"T"HH24:MI'),
	        END_DATE = TO_DATE(#{endDate}, 'YYYY-MM-DD"T"HH24:MI'),
	        ADDRESS = #{address},
	        NOTIFY_YN = #{notifyYn},
	        SCH_CONTENT = #{schContent},
	        MOD_DATE = SYSDATE,
	        CAL_NO = (
		            SELECT CAL_NO
		            FROM TB_CALENDAR
		            WHERE CAL_SUB_CODE = #{schCalSubCode}
		            AND REG_ID = #{modId}
		        )
	    WHERE SCH_NO = #{schNo}
	</update>
	
	<!-- 캘린더 메인 일정 삭제(상태 변경) -->
	<update id="deleteSch">
	 UPDATE TB_SCHEDULE
	 SET DEL_YN = 'Y'
	 WHERE SCH_NO = ${schNo}
	</update>

	<!--  캘린더 CAL_SUB_CODE 수정 
    <update id="updateCalendarSubCode">
        UPDATE TB_CALENDAR
        SET CAL_SUB_CODE = #{schCalSubCode}
        WHERE CAL_NO = #{calNo}
    </update> -->
    
 <!-- 휴지통 쿼리************************************* -->  
   <!-- 휴지통 리스트 조회 -->
   <select id="selectSchWasteList" resultMap="scheduleResult">
       SELECT 
           S.SCH_NO,
           S.SCH_CONTENT,
           S.SCH_TITLE,
           C.CAL_SUB_CODE,
           C.CAL_NO,
           TO_DATE(S.MOD_DATE, 'YY-MM-DD') AS MOD_DATE
       FROM TB_SCHEDULE S
       JOIN TB_CALENDAR C ON (C.CAL_NO = S.CAL_NO)
       WHERE C.CAL_SUB_CODE =  #{schCalSubCode}
       AND S.DEL_YN = 'Y'
   </select> 
   
   	<!-- 상세조회 -->
	<select id="detailSch" resultMap="scheduleResult">
       SELECT 
       	S.SCH_NO,
        S.SCH_CONTENT,
        TO_CHAR(S.START_DATE, 'YYYY-MM-DD"T"HH24:MI') AS START_DATE,
        TO_CHAR(S.END_DATE, 'YYYY-MM-DD"T"HH24:MI') AS END_DATE,
        S.ADDRESS,
        S.SCH_IMPORT,
        S.NOTIFY_YN,
        S.SCH_TITLE,
        C.CAL_SUB_CODE
       FROM TB_SCHEDULE S
       JOIN TB_CALENDAR C ON (C.CAL_NO = S.CAL_NO)
       WHERE S.SCH_NO =  #{schNo}
	 </select> 
  
  <!-- 휴지통 일정삭제 -->
	<delete id="deleteSchWaste">
	 DELETE 
	 		FROM TB_SCHEDULE
	 WHERE SCH_NO = ${schNo}
	 AND DEL_YN = 'Y'
	</delete>
	
	 <!-- 30일 뒤 휴지통 일정삭제(스케줄러) -->
	<delete id="wasteSchCompletely">
    <![CDATA[ 
        DELETE FROM TB_SCHEDULE
        WHERE DEL_YN = 'Y'
        AND MOD_DATE < ADD_MONTHS(SYSDATE, -1) + 1 
    ]]>
	</delete>
	<!-- 이 안에 있는 특수문자를 일반문자로 처리   --><!-- 30 +1일 째 삭제-->
	
	<!-- 휴지통 일정 복구(상태 변경) -->
	<update id="wasteSchRestore">
	 UPDATE TB_SCHEDULE
	 SET DEL_YN = 'N'
	 WHERE SCH_NO = ${schNo}
	</update>
	
	<!-- 캘린더 insert *************************************** -->
	<insert id="insertCal">

		INSERT INTO TB_CALENDAR
		    (
_CODE FROM DUAL
		         UNION ALL
		         SELECT '02' AS CAL_SUB_CODE FROM DUAL
		         UNION ALL
		         SELECT '03' AS CAL_SUB_CODE FROM DUAL
		         UNION ALL
		         SELECT '04' AS CAL_SUB_CODE FROM DUAL) sub	 
	  </insert>
</mapper>
