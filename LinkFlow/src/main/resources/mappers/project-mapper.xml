<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="projectMapper">
	<resultMap type="ProjectDto" id="projectResult" extends="commonMapper.commonResult">
		<id column="PRO_NO" property="proNo"/>
		<result column="DEPT_CODE" property="deptCode"/>
		<result column="PRO_TITLE" property="proTitle"/>
		<result column="CLIENT" property="client"/>
		<result column="ADDRESS" property="address"/>
		<result column="DETAIL_ADD" property="detailAdd"/>
		<result column="START_DATE" property="startDate"/>
		<result column="END_DATE" property="endDate"/>
		<result column="PRO_YN" property="proYn"/>
		<result column="DEPT_NAME" property="deptName"/>
	</resultMap>
	
	<resultMap type="DispatchDto" id="disResult" extends="commonMapper.commonResult">
		<result column="PRO_NO" property="proNo"/>
		<result column="USER_ID" property="userId"/>
		<result column="ROLE" property="role"/>
		<result column="TASK" property="task"/>
		<result column="START_DATE" property="startDate"/>
		<result column="END_DATE" property="endDate"/>
		<result column="DIS_YN" property="disYn"/>
		<result column="USER_NAME" property="userName"/>
	</resultMap>
	
	<!-- 프로젝트 등록 -->
	<insert id="addProject">
		INSERT
		  INTO TB_PROJECT
		  (
		  	PRO_NO
		  , DEPT_CODE
		  , PRO_TITLE
		  , CLIENT
		  , ADDRESS
		  , DETAIL_ADD
		  , START_DATE
		  , END_DATE
		  , REG_ID
		  , MOD_ID
		  )
		  VALUES
		  (
		  	SEQ_PROJECT.NEXTVAL
		  , #{deptCode}
		  , #{proTitle}
		  , #{client}
		  , #{address}
		  , #{detailAdd}
		  , #{startDate}
		  , #{endDate}
		  , #{regId}
		  , #{modId}
		  )
	</insert>
	
	<!-- 프로젝트 목록 조회 -->
	<select id="selectProjectList" resultMap="projectResult">
		SELECT
		       PRO_NO
		     , PRO_TITLE
		     , CLIENT
		     , DEPT_TITLE AS DEPT_NAME
		     , ADDRESS
		     , DETAIL_ADD
		     , TO_CHAR(START_DATE, 'YYYY-MM-DD') AS START_DATE
		     , TO_CHAR(END_DATE, 'YYYY-MM-DD') AS END_DATE
		     , PRO_YN
		  FROM TB_PROJECT P
		  JOIN TB_DEPT USING (DEPT_CODE)
		 WHERE P.DEL_YN = 'N'
		 ORDER
		    BY PRO_NO DESC
	</select>
	
	<!-- 프로젝트 목록조회 (팀장 아닌경우) -->
	<select id="selectPrivateProjectList" resultMap="projectResult">
		SELECT
		       PRO_NO
		     , PRO_TITLE
		     , CLIENT
		     , DEPT_TITLE AS DEPT_NAME
		     , ADDRESS
		     , DETAIL_ADD
		     , TO_CHAR(START_DATE, 'YYYY-MM-DD') AS START_DATE
		     , TO_CHAR(END_DATE, 'YYYY-MM-DD') AS END_DATE
		     , PRO_YN
		  FROM TB_PROJECT P
		  JOIN TB_DEPT USING (DEPT_CODE)
		  JOIN TB_DISPATH USING (PRO_NO)
		 WHERE P.DEL_YN = 'N'
		   AND USER_ID = #{id}
		 ORDER
		    BY PRO_NO DESC
	</select>
	
	<!-- 프로젝트 파견인원 조회 -->
	<select id="selectProjectDispatch" resultMap="disResult">
		SELECT
			   PRO_NO
		     , USER_NAME
		     , USER_ID
		     , ROLE
		     , TASK
		     , TO_CHAR(START_DATE, 'YYYY-MM-DD') AS START_DATE
		     , TO_CHAR(END_DATE, 'YYYY-MM-DD') AS END_DATE
		     , DIS_YN
		  FROM TB_DISPATCH D
		  JOIN TB_MEMBER USING (USER_ID)
		 WHERE PRO_NO = #{no}
		   AND D.DEL_YN = 'N'
		 ORDER
		    BY ROLE
	</select>
	
	<!-- 프로젝트 검색 목록 조회 -->
	<select id="searchListProject" resultMap="projectResult">
		SELECT
			   PRO_NO
			 , PRO_TITLE
			 , CLIENT
		     , DEPT_TITLE AS DEPT_NAME
		     , ADDRESS
		     , DETAIL_ADD
		     , TO_CHAR(START_DATE, 'YYYY-MM-DD') AS START_DATE
		     , TO_CHAR(END_DATE, 'YYYY-MM-DD') AS END_DATE
		     , PRO_YN
		  FROM TB_PROJECT P
		  JOIN TB_DEPT USING (DEPT_CODE)
		 WHERE P.DEL_YN = 'N'
		<if test="startDate != null and startDate != ''">
           AND START_DATE <![CDATA[>=]]> #{startDate}
    	</if>
    	<if test="endDate != null and endDate != ''">
       	   AND END_DATE <![CDATA[<=]]> #{endDate}
    	</if>
    	<if test="category != null and category != '' and category == 'proName'">
    	   AND PRO_TITLE LIKE '%' || #{keyword} || '%'
    	</if>
    	<if test="category != null and category != '' and category == 'client'">
    	   AND CLIENT LIKE '%' || #{keyword} || '%'
    	</if>
    	 ORDER
    	    BY PRO_NO DESC
	</select>
	
	<!-- 프로젝트 개수 조회 -->
	<select id="selectProjectCount" resultType="_int">
		SELECT
		       COUNT(*)
		  FROM TB_PROJECT
		 WHERE DEL_YN = 'N'
	</select>
	
	<!-- 프로젝트 검색 개수 조회 -->
	<select id="searchProjectCount" resultType="_int">
		SELECT
		       COUNT(*)
		  FROM TB_PROJECT
		 WHERE DEL_YN = 'N'
		<if test="startDate != null and startDate != ''">
           AND START_DATE <![CDATA[>=]]> #{startDate}
    	</if>
    	<if test="endDate != null and endDate != ''">
       	   AND END_DATE <![CDATA[<=]]> #{endDate}
    	</if>
    	<if test="category != null and category != '' and category == 'proName'">
    	   AND PRO_TITLE LIKE '%' || #{keyword} || '%'
    	</if>
    	<if test="category != null and category != '' and category == 'client'">
    	   AND CLIENT LIKE '%' || #{keyword} || '%'
    	</if>
	</select>
	
	<!-- 프로젝트 상세 조회 -->
	<select id="selectDetailProject" resultMap="projectResult">
		SELECT
		       PRO_NO
		     , PRO_TITLE
		     , CLIENT
		     , DEPT_TITLE AS DEPT_NAME
		     , ADDRESS
		     , DETAIL_ADD
		     , TO_CHAR(START_DATE, 'YYYY-MM-DD') AS START_DATE
		     , TO_CHAR(END_DATE, 'YYYY-MM-DD') AS END_DATE
		     , PRO_YN
		  FROM TB_PROJECT
		  JOIN TB_DEPT USING (DEPT_CODE)
		 WHERE PRO_NO = #{no}
	</select>
	
	<!-- 파견인원 등록 -->
	<insert id="addDispatch">
		INSERT
		  INTO TB_DISPATCH
		  (
		  	PRO_NO
		  , USER_ID
		  , ROLE
		  , TASK
		  , START_DATE
		  , END_DATE
		  , DIS_YN
		  , REG_ID
		  , MOD_ID
		  )
		  VALUES
		  (
		  	#{proNo}
		  , #{userId}
		  , #{role}
		  , #{task}
		  , #{startDate}
		  , #{endDate}
		  , #{disYn}
		  , #{regId}
		  , #{modId}
		  )
	</insert>
	
	<!-- 파견인원 등록 체크 -->
	<select id="checkDispatch" resultType="_int">
		SELECT
		       COUNT(*)
		  FROM TB_DISPATCH
		 WHERE PRO_NO = #{proNo}
	       AND USER_ID = #{userId}
	</select>
	
	<!-- 파견인원 수정 -->
	<update id="modifyDispatch">
		UPDATE
		       TB_DISPATCH
		   SET ROLE = #{role}
		     , TASK = #{task}
		     , START_DATE = #{startDate}
		     , END_DATE = #{endDate}
		     , DIS_YN = #{disYn}
		     , MOD_ID = #{modId}
		     , MOD_DATE = SYSDATE
		 WHERE PRO_NO = #{proNo}
		   AND USER_ID = #{userId}
	</update>
	
	<!-- 파견인원 삭제 -->
	<delete id="deleteDispatch">
		DELETE
		  FROM TB_DISPATCH
		 WHERE PRO_NO = #{proNo}
		   AND USER_ID = #{userId}
	</delete>
	
	<!-- 프로젝트 수정 -->
	<update id="modifyProject">
		UPDATE
		  	   TB_PROJECT
		   SET PRO_TITLE = #{proTitle}
		     , CLIENT = #{client}
		     , ADDRESS = #{address}
		     , DETAIL_ADD = #{detailAdd}
		     , START_DATE = #{startDate}
		     , END_DATE = #{endDate}
		     , MOD_ID = #{modId}
		 WHERE PRO_NO = #{proNo}
	</update>
	
	<!-- 프로젝트 삭제 -->
	<update id="deleteProject">
		UPDATE
		       TB_PROJECT
		   SET DEL_YN = 'Y'
		 WHERE PRO_NO = #{proNo}
	</update>
</mapper>
